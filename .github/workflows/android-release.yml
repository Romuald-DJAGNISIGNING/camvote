name: Android Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      upload_to_play:
        description: "Upload AAB to Google Play track"
        required: false
        default: false
        type: boolean
      play_track:
        description: "Google Play track"
        required: false
        default: "internal"
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      api_base_url:
        description: "CAMVOTE_API_BASE_URL override"
        required: false
        default: "https://camvote.romuald-djagnisigning.workers.dev"
        type: string

permissions:
  contents: write

jobs:
  build-release:
    name: Build Android Signed Release
    runs-on: ubuntu-latest
    env:
      CAMVOTE_FIREBASE_WEB_API_KEY: ${{ secrets.CAMVOTE_FIREBASE_WEB_API_KEY }}
      CAMVOTE_FIREBASE_ANDROID_API_KEY: ${{ secrets.CAMVOTE_FIREBASE_ANDROID_API_KEY }}
      CAMVOTE_FIREBASE_IOS_API_KEY: ${{ secrets.CAMVOTE_FIREBASE_IOS_API_KEY }}
      ANDROID_UPLOAD_KEYSTORE_BASE64: ${{ secrets.ANDROID_UPLOAD_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.ANDROID_GOOGLE_SERVICES_JSON_BASE64 }}
      IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 }}
      PLAY_STORE_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: stable
          cache: true

      - name: Resolve API Base URL
        id: api
        shell: bash
        run: |
          api="${{ inputs.api_base_url }}"
          if [ -z "$api" ]; then
            api="https://camvote.romuald-djagnisigning.workers.dev"
          fi
          echo "value=$api" >> "$GITHUB_OUTPUT"

      - name: Validate Release Secrets
        shell: bash
        run: |
          missing=0
          for key in \
            CAMVOTE_FIREBASE_WEB_API_KEY \
            CAMVOTE_FIREBASE_ANDROID_API_KEY \
            CAMVOTE_FIREBASE_IOS_API_KEY \
            ANDROID_UPLOAD_KEYSTORE_BASE64 \
            ANDROID_KEYSTORE_PASSWORD \
            ANDROID_KEY_ALIAS \
            ANDROID_KEY_PASSWORD
          do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required repository secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Restore google-services.json
        shell: bash
        run: |
          if [ -f android/app/google-services.json ]; then
            exit 0
          fi
          if [ -z "$ANDROID_GOOGLE_SERVICES_JSON_BASE64" ]; then
            echo "::error::android/app/google-services.json is missing and ANDROID_GOOGLE_SERVICES_JSON_BASE64 was not provided."
            exit 1
          fi
          mkdir -p android/app
          printf '%s' "$ANDROID_GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > android/app/google-services.json

      - name: Restore GoogleService-Info.plist (for validation)
        shell: bash
        run: |
          if [ -f ios/Runner/GoogleService-Info.plist ]; then
            exit 0
          fi
          if [ -z "$IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
            echo "::error::ios/Runner/GoogleService-Info.plist is missing and IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 was not provided."
            exit 1
          fi
          mkdir -p ios/Runner
          printf '%s' "$IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > ios/Runner/GoogleService-Info.plist

      - name: Configure Android Signing
        shell: bash
        run: |
          mkdir -p android/app
          printf '%s' "$ANDROID_UPLOAD_KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          cat > android/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF

      - name: Install Dependencies
        run: flutter pub get

      - name: Validate Firebase Mobile Config
        run: dart run tools/validate_firebase_mobile_config.dart

      - name: Build App Bundle
        run: >
          flutter build appbundle --release
          --dart-define=CAMVOTE_API_BASE_URL=${{ steps.api.outputs.value }}
          --dart-define=CAMVOTE_FIREBASE_WEB_API_KEY=${{ env.CAMVOTE_FIREBASE_WEB_API_KEY }}
          --dart-define=CAMVOTE_FIREBASE_ANDROID_API_KEY=${{ env.CAMVOTE_FIREBASE_ANDROID_API_KEY }}
          --dart-define=CAMVOTE_FIREBASE_IOS_API_KEY=${{ env.CAMVOTE_FIREBASE_IOS_API_KEY }}

      - name: Build Split APKs
        run: >
          flutter build apk --release --split-per-abi
          --dart-define=CAMVOTE_API_BASE_URL=${{ steps.api.outputs.value }}
          --dart-define=CAMVOTE_FIREBASE_WEB_API_KEY=${{ env.CAMVOTE_FIREBASE_WEB_API_KEY }}
          --dart-define=CAMVOTE_FIREBASE_ANDROID_API_KEY=${{ env.CAMVOTE_FIREBASE_ANDROID_API_KEY }}
          --dart-define=CAMVOTE_FIREBASE_IOS_API_KEY=${{ env.CAMVOTE_FIREBASE_IOS_API_KEY }}

      - name: Create Checksums
        shell: bash
        run: |
          sha256sum \
            build/app/outputs/bundle/release/app-release.aab \
            build/app/outputs/flutter-apk/*release*.apk \
            > build/mobile-android-sha256.txt

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-artifacts
          path: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/flutter-apk/*release*.apk
            build/mobile-android-sha256.txt
          if-no-files-found: error
          retention-days: 14

      - name: Publish GitHub Release Assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/flutter-apk/*release*.apk
            build/mobile-android-sha256.txt

      - name: Upload to Google Play
        if: github.event_name == 'workflow_dispatch' && inputs.upload_to_play == true
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ env.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: com.camvote.app
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: ${{ inputs.play_track }}
          status: completed
