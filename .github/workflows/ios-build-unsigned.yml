name: iOS Build (Unsigned)

on:
  push:
    branches:
      - main
    paths:
      - "ios/**"
      - "lib/**"
      - "pubspec.yaml"
      - "pubspec.lock"
      - ".github/workflows/ios-build-unsigned.yml"
  workflow_dispatch:
    inputs:
      api_base_url:
        description: "CAMVOTE_API_BASE_URL override"
        required: false
        default: "https://camvote.romuald-djagnisigning.workers.dev"
        type: string

permissions:
  contents: read

jobs:
  build-ios-unsigned:
    name: Build iOS Unsigned Archive
    runs-on: macos-latest
    env:
      CAMVOTE_FIREBASE_WEB_API_KEY: ${{ secrets.CAMVOTE_FIREBASE_WEB_API_KEY }}
      CAMVOTE_FIREBASE_ANDROID_API_KEY: ${{ secrets.CAMVOTE_FIREBASE_ANDROID_API_KEY }}
      CAMVOTE_FIREBASE_IOS_API_KEY: ${{ secrets.CAMVOTE_FIREBASE_IOS_API_KEY }}
      IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: stable
          cache: true

      - name: Resolve API Base URL
        id: api
        shell: bash
        run: |
          api="${{ inputs.api_base_url }}"
          if [ -z "$api" ]; then
            api="https://camvote.romuald-djagnisigning.workers.dev"
          fi
          echo "value=$api" >> "$GITHUB_OUTPUT"

      - name: Validate Required Secrets
        shell: bash
        run: |
          missing=0
          for key in \
            CAMVOTE_FIREBASE_WEB_API_KEY \
            CAMVOTE_FIREBASE_ANDROID_API_KEY \
            CAMVOTE_FIREBASE_IOS_API_KEY
          do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required repository secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Restore GoogleService-Info.plist
        shell: bash
        run: |
          if [ -f ios/Runner/GoogleService-Info.plist ]; then
            exit 0
          fi
          if [ -n "$IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64" ]; then
            mkdir -p ios/Runner
            printf '%s' "$IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > ios/Runner/GoogleService-Info.plist
            exit 0
          fi

          echo "::warning::IOS_GOOGLE_SERVICE_INFO_PLIST_BASE64 is not set. Generating fallback ios/Runner/GoogleService-Info.plist from known Firebase iOS settings."
          mkdir -p ios/Runner
          cat > ios/Runner/GoogleService-Info.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>API_KEY</key>
            <string>${CAMVOTE_FIREBASE_IOS_API_KEY}</string>
            <key>GCM_SENDER_ID</key>
            <string>543751728187</string>
            <key>PLIST_VERSION</key>
            <string>1</string>
            <key>BUNDLE_ID</key>
            <string>com.camvote.app</string>
            <key>PROJECT_ID</key>
            <string>camvote--backend</string>
            <key>STORAGE_BUCKET</key>
            <string>camvote--backend.firebasestorage.app</string>
            <key>IS_ADS_ENABLED</key>
            <false/>
            <key>IS_ANALYTICS_ENABLED</key>
            <false/>
            <key>IS_APPINVITE_ENABLED</key>
            <true/>
            <key>IS_GCM_ENABLED</key>
            <true/>
            <key>IS_SIGNIN_ENABLED</key>
            <true/>
            <key>GOOGLE_APP_ID</key>
            <string>1:543751728187:ios:46947c86fcd4026f6ac01e</string>
          </dict>
          </plist>
          EOF

      - name: Install Dependencies
        run: flutter pub get

      - name: Validate Firebase Mobile Config
        run: dart run tools/validate_firebase_mobile_config.dart --allow-missing-native-files

      - name: Install CocoaPods Dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd ios
          pod install --repo-update

      - name: Build Unsigned iOS App
        id: build
        shell: bash
        continue-on-error: true
        run: |
          set -euo pipefail
          flutter build ios --release --no-codesign \
            --dart-define=CAMVOTE_API_BASE_URL=${{ steps.api.outputs.value }} \
            --dart-define=CAMVOTE_FIREBASE_WEB_API_KEY=${{ env.CAMVOTE_FIREBASE_WEB_API_KEY }} \
            --dart-define=CAMVOTE_FIREBASE_ANDROID_API_KEY=${{ env.CAMVOTE_FIREBASE_ANDROID_API_KEY }} \
            --dart-define=CAMVOTE_FIREBASE_IOS_API_KEY=${{ env.CAMVOTE_FIREBASE_IOS_API_KEY }} \
            -v 2>&1 | tee ios-build.log

      - name: Extract Build Errors
        if: always()
        shell: bash
        run: |
          if [ ! -f ios-build.log ]; then
            echo "::warning::ios-build.log not found."
            exit 0
          fi

          # Prefer the most actionable lines; keep the volume low so annotations remain readable.
          grep -nE '(^|\\b)(error:|fatal error:)' ios-build.log | tail -n 50 | while IFS= read -r line; do
            # Escape workflow command control characters.
            msg="$(printf '%s' "$line" | sed -e 's/%/%25/g' -e 's/\r/%0D/g')"
            echo "::error::${msg}"
          done || true

      - name: Package iOS Artifacts
        id: package
        shell: bash
        if: always()
        run: |
          set -euo pipefail
          mkdir -p release-artifacts/ios

          if [ -f ios-build.log ]; then
            cp ios-build.log release-artifacts/ios/ios-build.log
          fi

          if [ -d build/ios/iphoneos/Runner.app ]; then
            runner_app_zip="release-artifacts/ios/Runner.app.zip"
            ditto -c -k --sequesterRsrc --keepParent build/ios/iphoneos/Runner.app "$runner_app_zip"
          fi

          archive_path=$(find build/ios/archive -maxdepth 1 -name "*.xcarchive" | head -n 1 || true)
          if [ -n "$archive_path" ]; then
            archive_zip="release-artifacts/ios/$(basename "$archive_path").zip"
            ditto -c -k --sequesterRsrc --keepParent "$archive_path" "$archive_zip"
          fi

          ipa_path=$(find build/ios/ipa -maxdepth 1 -name "*.ipa" | head -n 1 || true)
          if [ -n "$ipa_path" ]; then
            cp "$ipa_path" release-artifacts/ios/
          fi

          (
            cd release-artifacts/ios
            shopt -s nullglob
            files=( * )
            if [ "${#files[@]}" -eq 0 ]; then
              echo "::error::No iOS artifacts were packaged."
              exit 1
            fi
            shasum -a 256 "${files[@]}" > sha256.txt
          )

          echo "path=release-artifacts/ios" >> "$GITHUB_OUTPUT"

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-unsigned-artifacts
          path: ${{ steps.package.outputs.path }}
          if-no-files-found: error
          retention-days: 14

      - name: Fail If Build Failed
        if: steps.build.outcome != 'success'
        run: exit 1
